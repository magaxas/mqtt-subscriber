<%-
local function generate_config(config, delimiter)
	write("{")
	for name, val in pairs(config) do
		if type(val) == "table" then
			write(name .. ":")
			generate_config(val, true)
		else
			if type(val) == "boolean" then
				val = val and "true" or "false"
			end
			write(name .. ":" .. "\"" ..val .."\",")
		end
	end
	if delimiter then write("},") else write("}") end
end
-%>

<!-- tblsection -->
<script src="<%=resource%>/vanilla-dataTables.js"></script>
<% if self.title and #self.title > 0 then -%>
		<h3 class="content-title <%=(#self.description > 0) and ' note-after hoverable' or ' '%>" 
			onclick="toggleContent(this, '<%=self.config%>.<%=self.sectiontype%>.<%=self.title%>.toggle')">
			<div class="toggle-arrow expanded"><img src="<%=media%>/img/icons/arrow-toggle.svg"></div>
			<span><%=self.title%>
				<% if self.description and #self.description > 0 then %>
					<div class="label-info"><%=self.description%></div>
				<% end %>
			</span>
		</h3>
<%- end %>
<div id="<%=self.config%>.<%=self.sectiontype%>.<%=self.title%>.toggle" class="toggle-content">
	<div class="table-wrapper">
		<table id="messages-table" style="word-wrap: anywhere;">
			<thead>
				<tr>
					<% local i, k
					for i, k in ipairs(self.children) do
						if not k.optional then%>
							<th><%=k.title%></th>
						<%end
					end %>
					<% if self.addremove then -%>
						<th><input type="checkbox" id="select-all"></th>
					<%-end-%>
				</tr>
			</thead>
			<tbody>
				<%-
				local isempty, i, k
				local ctrl = require "luci.controller.mqttsub"
				local messages = ctrl.get_messages()

				for i, k in ipairs(messages) do
					isempty = false
				-%>
					<tr class="cbi-section-table-row">
						<%-
							local index, node
							for index, node in ipairs(self.children) do
								if not node.optional then -%>
									<td class="input-cell word-break">
										<div class="div-heading">
											<%=node.title%>
										</div>
										<%=messages[node.title]%>
									</td><%-
								end
							end
						-%>
						<% if self.addremove then -%>
							<td>
								<div class="div-heading">Select</div>
								<input name="cbid.<%=self.config%>.__selected__" type="checkbox" value="<%=id%>">
							</td>
						<% end -%>
					</tr>
				<%- end -%>
				<%- if isempty then -%>
					<tr>
						<td class="left-aligned" colspan="3">
							<em><%:There are no messages%></em>
						</td>
					</tr>
				<%- end -%>
			</tbody>
		</table>
	</div>
	<div class="btn-group right-align">
		<%- if self.refresh then -%>
			<button class="btn medium-btn" onclick="location.reload();">refresh</button>
		<%- end; if self.addremove then -%>
			<button class="btn medium-btn" name="cbi.rts.<%=self.config%>.__delete__">delete</button>
		<%- end -%>
	</div>
</div>
<script>
	var config = <%generate_config(self.table_config)%>;
	var table = new DataTable("#messages-table", config);

    <%- if self.addremove then -%>
		document.querySelector("#select-all").addEventListener("click", function(ev) {
			var checked = this.checked;
			document.getElementsByName('cbid.<%=self.config%>.__selected__').forEach(function(e) {
				e.checked = checked;
			});
		});
	<%- end -%>
</script>
<!-- /tblsection -->
